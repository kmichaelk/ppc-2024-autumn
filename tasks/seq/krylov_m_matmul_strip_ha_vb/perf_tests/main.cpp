#include <gtest/gtest.h>

#include <functional>
#include <vector>

#include "../include/mmul_seq.hpp"
#include "core/perf/include/perf.hpp"

class krylov_m_matmul_strip_ha_vb_seq_perf_test : public ::testing::Test {
  using TestElementType = int64_t;

 protected:
  static void run_perf_test(
      const std::function<void(ppc::core::Perf &perfAnalyzer, const std::shared_ptr<ppc::core::PerfAttr> &perfAttr,
                               const std::shared_ptr<ppc::core::PerfResults> &perfResults)> &runner) {
    //
    krylov_m_matmul_strip_ha_vb_seq::TaskSequential<TestElementType>::Matrix out;

    krylov_m_matmul_strip_ha_vb_seq::TMatrix<TestElementType> lhs{32, 32};
    krylov_m_matmul_strip_ha_vb_seq::TMatrix<TestElementType> rhs{32, 32};

    krylov_m_matmul_strip_ha_vb_seq::TaskSequential<TestElementType>::Matrix ref{32, 32};

    lhs.data = {
        19,  29,  -45, 0,   -3,  57,  34,  -17, -46, 17,  20,  36,  1,   60,  -9,  38,  28,  -37, 55,  35,  -27, -39,
        18,  -2,  -42, -61, 48,  -49, -50, -40, 15,  -21, 54,  -50, -17, 46,  -3,  -6,  9,   16,  50,  25,  -24, 49,
        33,  37,  21,  44,  50,  44,  43,  -16, 26,  -39, -59, -58, 14,  -19, -32, 42,  27,  -61, 17,  -52, 50,  -60,
        5,   -20, -6,  45,  -26, 39,  -37, -62, 30,  -41, -17, -14, -23, 56,  -31, 52,  -56, -26, -9,  -11, 41,  -27,
        -31, -27, 2,   -62, -2,  -57, 5,   -13, 33,  3,   -35, -27, -55, 0,   -40, -60, 31,  -19, -45, 27,  4,   45,
        30,  -24, 40,  55,  63,  47,  43,  -2,  29,  54,  -9,  -24, 64,  -44, -14, 45,  -2,  -54, 18,  27,  47,  55,
        27,  -62, 38,  17,  38,  -8,  22,  -54, 50,  36,  -30, -63, -10, -14, 10,  38,  -61, -62, 54,  -57, 25,  60,
        28,  -33, 5,   -36, -28, -2,  -39, -43, 10,  -16, -48, -44, -44, 26,  35,  -33, 31,  29,  -53, 10,  8,   -50,
        42,  -50, 28,  22,  50,  -13, 34,  38,  -35, -21, -28, 8,   -24, -54, 19,  22,  63,  34,  64,  -21, -20, -44,
        -6,  5,   56,  51,  7,   -25, 4,   25,  -51, -8,  11,  48,  -47, -18, 37,  -52, 45,  55,  53,  28,  -48, -50,
        -53, 49,  -11, -4,  27,  55,  -18, 27,  60,  -56, 25,  39,  26,  18,  33,  -17, -64, -1,  -10, -37, -41, -32,
        9,   50,  -23, -29, -53, 32,  -29, -51, -26, -24, 3,   37,  -12, 31,  -52, 31,  36,  -4,  -27, 41,  58,  8,
        -54, 48,  -43, 32,  0,   22,  29,  29,  -44, 63,  -1,  -48, 54,  56,  42,  50,  -35, 19,  -12, -5,  0,   16,
        -22, -52, 4,   -22, -50, 39,  -27, 24,  34,  62,  -33, -37, -29, 44,  24,  -7,  -49, -35, 39,  -60, 30,  -11,
        33,  -40, 37,  5,   -21, -5,  -62, -30, -62, 63,  -7,  -40, 1,   57,  21,  1,   -32, -34, 51,  -62, 12,  11,
        52,  12,  -23, 40,  -58, -30, -48, -32, -31, -32, -40, -23, -1,  -63, 40,  59,  35,  38,  1,   55,  11,  1,
        11,  -30, -4,  51,  9,   -60, -64, 28,  -30, -43, -63, 63,  -43, -3,  -12, -40, 31,  56,  48,  58,  60,  17,
        -13, 39,  47,  -38, -17, 59,  50,  18,  -12, -19, 60,  -14, 7,   -45, 34,  -37, -49, -22, 25,  62,  57,  -17,
        21,  43,  -43, 2,   23,  -42, -25, 14,  49,  2,   -17, 17,  52,  -19, 26,  57,  -9,  -61, 22,  39,  17,  62,
        18,  -30, -35, 3,   17,  -53, 2,   21,  37,  -55, 24,  19,  -11, 0,   -1,  -61, 25,  -16, 22,  -58, 13,  -21,
        39,  41,  5,   -28, -9,  61,  46,  63,  49,  26,  17,  -37, -42, 38,  -3,  41,  -37, -26, 2,   27,  -63, 34,
        49,  1,   -17, 6,   -62, 39,  -56, 51,  -8,  64,  2,   -53, -14, 18,  34,  39,  -56, 38,  49,  -59, -1,  57,
        40,  12,  -11, -46, -34, 20,  51,  10,  3,   -50, -10, -38, -24, 26,  22,  -44, 14,  33,  64,  16,  -8,  35,
        -50, -35, 42,  -4,  -2,  -13, 5,   2,   -55, 32,  34,  -13, 20,  -50, -10, 54,  5,   48,  16,  -49, 23,  55,
        -18, 4,   -1,  -63, -41, 63,  0,   -48, 63,  -54, 19,  -44, 15,  -35, -58, 0,   -45, -40, 32,  -56, -64, 56,
        50,  43,  -1,  -5,  50,  -61, 33,  -19, -62, 57,  6,   -37, 17,  -13, -22, 26,  1,   -30, 1,   36,  50,  -37,
        57,  50,  -42, 53,  -9,  -43, -19, 14,  39,  -30, -54, -50, 28,  -55, 4,   28,  -38, -61, -14, -58, 52,  -2,
        48,  6,   7,   13,  32,  -53, -57, -20, 55,  46,  -48, -40, 57,  -50, 19,  -16, -20, 39,  -44, -46, 37,  -17,
        38,  -18, 33,  -50, 34,  53,  26,  -44, -55, -29, -55, -29, -36, -51, -57, 48,  18,  33,  10,  -17, -22, -5,
        -7,  15,  -27, -22, 49,  9,   24,  54,  -51, 20,  -30, 44,  -43, -13, -5,  -64, 12,  -14, 49,  -29, 10,  9,
        -48, 27,  -33, 14,  7,   -7,  -55, 60,  -62, -60, 16,  -63, -41, 61,  -35, -29, -62, -40, 64,  -24, -28, 52,
        -23, 39,  32,  7,   -59, -63, 57,  53,  -11, 48,  -20, 16,  39,  41,  13,  43,  -53, -45, -47, -6,  -1,  36,
        7,   10,  60,  56,  12,  27,  60,  59,  38,  31,  28,  -52, 19,  41,  27,  -54, -28, -52, -36, -20, 6,   33,
        31,  28,  -56, 17,  38,  -44, -60, -13, -57, 46,  32,  44,  -28, 4,   53,  -39, 59,  36,  26,  44,  20,  61,
        52,  -36, 1,   -61, 39,  -52, -34, 0,   -18, -31, -12, 9,   33,  -22, 59,  -28, 48,  60,  -40, -59, -45, 63,
        14,  -3,  18,  -7,  23,  -32, 58,  -23, 19,  30,  14,  5,   -21, -60, 8,   -34, -2,  -21, -31, 63,  0,   1,
        36,  17,  -57, -48, -37, -22, 31,  37,  -52, 8,   16,  -49, -54, -56, -6,  10,  16,  0,   -17, -8,  -14, -25,
        -24, -14, -6,  -16, 20,  -30, 42,  -20, 34,  -8,  22,  48,  -8,  5,   -22, 4,   -1,  52,  55,  -48, -41, -49,
        61,  59,  -20, 62,  48,  -53, 16,  30,  -47, 4,   36,  0,   -56, -10, -17, 54,  47,  0,   61,  -34, -50, -1,
        -61, -43, 63,  63,  -64, -47, 33,  -63, 32,  -57, -21, 57,  -42, -38, -5,  -23, -43, 33,  51,  -26, -61, -17,
        36,  32,  -39, -25, 8,   -29, -5,  38,  57,  13,  -40, 59,  -22, 15,  7,   -17, 16,  -15, 12,  51,  55,  -9,
        21,  28,  -9,  -51, -31, 62,  38,  27,  -44, -53, -9,  -8,  9,   55,  37,  30,  54,  -50, 10,  -48, 53,  -6,
        4,   -21, -23, 60,  -60, 14,  -18, 36,  2,   -33, -40, -46, 57,  36,  -29, -1,  -5,  -43, 60,  9,   45,  -29,
        0,   15,  59,  14,  39,  47,  -7,  -9,  61,  -27, 58,  8,   61,  20,  -20, -50, 38,  50,  -58, -44, 7,   -22,
        -52, 31,  -49, 15,  -48, -11, -24, 3,   9,   -59, 63,  -60, -24, 60,  -12, 0,   53,  8,   18,  30,  -43, 7,
        -32, 60,  35,  -50, 59,  -46, 60,  -26, -32, 34,  15,  1,   14,  8,   -20, 50,  -11, -22, -8,  18,  -59, -47,
        -64, 59,  -3,  -30, -14, -2,  56,  31,  18,  -34, 41,  29};

    rhs.data = {
        -53, 37,  6,   -43, 52,  20,  3,   4,   60,  54,  5,   -48, -33, -57, -60, -12, 7,   -15, -47, -55, 59,  41,
        -35, 45,  -52, -45, 38,  47,  49,  -47, -46, -49, 31,  0,   -31, -52, -58, 44,  -50, -33, 18,  12,  -36, -36,
        11,  54,  -40, -5,  -30, 3,   27,  8,   14,  -23, -64, 1,   13,  9,   51,  -4,  8,   -14, -5,  -26, -53, 12,
        62,  -57, -14, 47,  17,  -50, 62,  61,  64,  -17, -3,  61,  9,   35,  -37, -5,  50,  20,  16,  -45, 17,  31,
        -5,  39,  32,  17,  55,  -62, -58, -17, -3,  25,  16,  -20, -8,  41,  22,  51,  -33, 31,  47,  38,  11,  37,
        22,  -27, -51, 44,  -24, -44, -51, 23,  43,  3,   -37, 13,  -64, -16, -14, -16, -37, 0,   -13, 64,  18,  -16,
        -58, -59, -58, 7,   -41, 56,  -52, 63,  33,  -36, 42,  -21, -10, 18,  -37, 17,  -57, -20, 1,   43,  18,  -14,
        -1,  -32, 5,   7,   35,  1,   6,   -46, -32, -12, 59,  35,  -46, 59,  16,  -39, 31,  -8,  43,  6,   -1,  11,
        3,   51,  -48, -33, 30,  -10, -3,  55,  -9,  53,  -8,  15,  -42, 45,  57,  -55, 36,  -24, -46, 40,  -29, 12,
        60,  51,  2,   -21, -18, -63, -17, 5,   -63, 22,  61,  -13, 8,   60,  8,   50,  27,  29,  55,  25,  -33, -44,
        23,  -43, -43, -7,  64,  -33, 22,  -15, -25, -20, 52,  40,  60,  30,  -55, -7,  -24, -61, -23, -56, 0,   34,
        -46, 34,  23,  -31, 60,  -23, 0,   -24, 55,  -22, -53, -64, 50,  32,  4,   2,   23,  -18, -28, 26,  -43, -25,
        58,  52,  -5,  -50, -63, 53,  10,  51,  54,  -26, -24, 34,  -51, 60,  30,  -15, -24, 54,  -47, 10,  -62, -30,
        63,  10,  -22, -45, 59,  25,  -35, 27,  55,  -15, -23, -20, -3,  -44, -45, 18,  -59, 16,  -42, 44,  59,  9,
        64,  -13, 2,   4,   -25, 14,  43,  56,  40,  -57, -2,  38,  57,  -22, 29,  -20, -60, 32,  -15, -6,  55,  -14,
        -28, 0,   -52, 25,  4,   1,   25,  32,  9,   41,  46,  -54, 33,  -46, -58, -16, -10, -27, 45,  39,  -1,  -10,
        48,  -53, -53, 63,  41,  35,  -60, -38, -19, 20,  42,  -48, -26, 41,  17,  -37, 30,  -14, 57,  -27, 59,  -13,
        51,  -28, 53,  -31, 12,  -37, 44,  -48, -17, -44, 45,  25,  51,  3,   48,  -29, -30, 10,  -29, 8,   51,  -9,
        -6,  40,  -47, 7,   50,  52,  -54, -55, -14, -45, -15, -13, -21, -30, -26, 63,  -38, 25,  37,  20,  47,  -20,
        -4,  -54, -51, -24, 55,  -7,  63,  13,  46,  -63, -43, -54, -45, -32, 36,  40,  -53, -22, 64,  -60, -35, 20,
        32,  -2,  -16, 9,   42,  43,  -46, 44,  -61, -6,  5,   56,  1,   21,  -9,  -34, 29,  13,  -58, 54,  19,  63,
        -44, 21,  33,  -9,  16,  29,  16,  -44, -48, -12, 8,   17,  20,  -15, 35,  36,  35,  -47, 47,  -10, 30,  42,
        30,  62,  27,  4,   47,  60,  -45, 46,  -21, -56, -56, -33, 8,   47,  9,   56,  -23, -53, 26,  55,  -24, -4,
        -18, 17,  55,  -33, -53, 37,  32,  -59, 27,  -49, 11,  -45, -63, -30, 46,  -6,  -44, -37, -51, 3,   -39, 20,
        14,  -36, -6,  -58, 7,   -4,  0,   -5,  -2,  63,  -8,  -49, 25,  43,  26,  30,  51,  36,  -2,  -46, 42,  36,
        46,  50,  -21, -22, 5,   10,  31,  4,   -14, 12,  38,  53,  55,  0,   30,  -34, 48,  -32, 13,  10,  25,  -7,
        49,  25,  1,   -27, 50,  64,  2,   -48, 33,  32,  6,   19,  59,  47,  -9,  -47, 36,  53,  33,  -15, 44,  -1,
        34,  29,  -11, -47, 47,  -57, -42, -46, 11,  38,  36,  22,  -21, 59,  27,  -14, -16, -24, 28,  18,  -21, -19,
        -41, -13, -30, 35,  -46, 4,   -21, -13, -18, -61, -2,  -3,  44,  -28, 2,   -35, -39, 48,  38,  15,  60,  52,
        -38, -4,  -36, -64, -34, -19, -12, 30,  57,  -19, -47, -38, 11,  25,  -36, -59, -31, -48, 12,  57,  30,  -23,
        -12, 38,  -14, -1,  -37, -14, 4,   -24, -31, -63, -47, -56, -2,  -55, 11,  16,  -34, -25, 61,  -64, -38, -40,
        -10, 23,  21,  -14, -17, -45, 21,  -44, 26,  -38, -6,  -20, -31, -39, -14, -28, 64,  -4,  2,   43,  26,  -23,
        -52, -33, 62,  0,   23,  -30, -30, -57, -54, 60,  -3,  15,  -25, 44,  52,  50,  -20, -4,  -32, -9,  -35, -2,
        -50, 8,   60,  -18, 7,   -28, -3,  44,  28,  56,  -4,  6,   55,  6,   44,  24,  -23, -21, -3,  52,  -36, -62,
        -8,  -7,  48,  -60, -48, -58, -62, -24, 49,  5,   39,  -17, 25,  -24, -59, -49, 3,   35,  11,  63,  25,  -34,
        -32, 17,  -21, -37, 3,   -38, 8,   16,  59,  -27, -45, 58,  -40, 1,   17,  36,  -49, 12,  -56, 1,   12,  37,
        -11, -9,  17,  47,  13,  -45, 34,  -23, -30, 55,  0,   -32, -27, 18,  -5,  -6,  -35, -53, -16, 43,  -12, -46,
        -59, -37, -3,  -4,  -47, -22, 29,  -32, 15,  48,  -41, 25,  -25, 55,  15,  8,   -28, -47, 27,  40,  25,  -16,
        61,  -29, 23,  1,   -38, 27,  -43, 60,  12,  38,  -37, 34,  -49, 2,   0,   -54, -19, -11, 2,   -6,  -34, -32,
        42,  11,  27,  55,  20,  -23, -7,  -7,  60,  -7,  6,   -20, -23, -31, -37, -14, 0,   32,  -23, -15, 25,  19,
        -5,  -36, -24, 14,  -33, -52, 13,  -17, -10, -10, -27, 46,  20,  -47, -5,  -24, -25, 27,  59,  -12, -36, 48,
        -56, 62,  -5,  49,  39,  7,   -44, -59, 29,  22,  -33, -59, -40, -28, -44, 50,  -4,  41,  42,  27,  45,  -6,
        42,  -13, -35, -13, -43, 51,  -64, 26,  53,  -12, 62,  -43, 22,  60,  45,  -52, 62,  50,  30,  -4,  -38, 28,
        59,  -36, 49,  -7,  -37, 19,  -13, -3,  59,  59,  -44, -32, 24,  -9,  -20, 18,  36,  60,  42,  -35, -32, 60,
        -59, 44,  55,  64,  -3,  -46, 27,  41,  -27, -57, 5,   35,  -13, 53,  47,  34,  35,  -53, -18, 57,  -39, -49,
        -24, 59,  -22, -19, -19, 37,  36,  29,  23,  40,  -20, -33, 9,   26,  -53, 56,  46,  -9,  46,  40,  54,  -17,
        -41, -26, 19,  -39, 40,  -38, 20,  -63, 17,  -7,  -35, 26};

    ASSERT_TRUE(lhs.check_integrity());
    ASSERT_TRUE(rhs.check_integrity());

    ref.data = {
        18681,  -6684,  -5840,  -582,   10242,  687,    -5136,  7144,   7941,   3057,   -8360,  -8539,  1238,   1293,
        -7976,  -613,   2332,   4048,   -625,   -117,   13900,  -5598,  -1593,  -921,   1548,   -3847,  -3198,  -5192,
        9474,   15893,  -4600,  11540,  12865,  -1784,  5736,   -4386,  579,    5676,   -3028,  11865,  12086,  5019,
        6999,   -5198,  -12019, -12416, -15269, 771,    15507,  5554,   -5605,  2582,   -2375,  2781,   13779,  3084,
        -7194,  3668,   -9934,  8890,   7951,   -15676, -7087,  -2274,  453,    -439,   3828,   -1910,  7659,   332,
        3586,   15360,  5017,   -317,   -3268,  14401,  4470,   -20584, 924,    1089,   1003,   9011,   -8905,  3068,
        -888,   3368,   1484,   8152,   986,    -3379,  -405,   -7834,  -2103,  7419,   62,     -1313,  1735,   3762,
        -6533,  -9086,  22987,  774,    -865,   -11847, 2062,   8609,   322,    -13470, 4483,   8908,   -3621,  1246,
        901,    -7499,  3544,   -17189, 14360,  2661,   -8583,  -8531,  -4122,  -695,   4697,   4713,   4512,   19508,
        2961,   899,    2832,   16884,  8753,   -20121, -15854, -5620,  -3756,  3044,   3749,   7731,   2804,   -1978,
        -9855,  12211,  -6265,  11001,  -135,   2621,   -15414, 1362,   -8516,  -1039,  -1535,  3107,   -4060,  6383,
        -3775,  5178,   3971,   4115,   -3498,  5326,   -1941,  -15102, 5119,   -1043,  -2342,  -1866,  -7447,  -9395,
        3282,   -2447,  -4896,  -1600,  -13871, 232,    16274,  -1743,  3112,   -14773, 2242,   4102,   119,    3551,
        7465,   -18132, 3455,   -1564,  -8505,  -16983, -4119,  3553,   -1303,  11741,  -7882,  -955,   1725,   -12189,
        -3320,  4127,   9753,   -14142, 12291,  10339,  8473,   -25064, -12593, 4947,   -8377,  337,    -3049,  10996,
        56,     -671,   14018,  4936,   -2739,  7700,   -2816,  3463,   136,    6112,   -1600,  -16484, -2700,  5058,
        677,    8877,   -7811,  -2319,  -14336, 4922,   2830,   4342,   9165,   9291,   -11335, -9543,  -1309,  978,
        9432,   -7082,  -6670,  -5547,  5355,   10447,  5283,   6767,   2457,   -6938,  -194,   -1746,  5211,   -10042,
        215,    -8543,  -4506,  5837,   -1360,  -9736,  -543,   4318,   -459,   11598,  18708,  -4499,  -7594,  -4406,
        1627,   -6474,  12524,  -2022,  -7928,  -7818,  -2820,  9154,   10819,  891,    14087,  -7520,  -3146,  3705,
        10751,  1203,   4457,   -2945,  3273,   -2803,  -3735,  -4502,  4923,   -7030,  -16826, 2796,   9568,   -8725,
        1734,   1820,   2652,   377,    5521,   -17616, 6819,   -3019,  5213,   -10586, 1590,   5395,   -6169,  -6956,
        8108,   9037,   1802,   -916,   2503,   -3211,  -9164,  -4035,  -21721, -5810,  4898,   7136,   -1518,  7328,
        -8778,  -1121,  -13103, -400,   4594,   -6025,  -326,   -2868,  15073,  -8622,  -4060,  10539,  -4710,  10265,
        -3591,  1403,   5378,   3125,   1986,   1923,   -5662,  8724,   -122,   187,    501,    14099,  4335,   -11066,
        -10238, -8761,  809,    928,    -1911,  -7840,  7981,   -1476,  -827,   -5752,  -8945,  8584,   7324,   479,
        -1361,  -5895,  14110,  -13187, -6461,  -11351, 1825,   -12198, -4158,  1818,   9035,   -11528, 652,    -5445,
        7622,   -4160,  7211,   -6871,  -6530,  -3360,  -341,   -9350,  16103,  -5941,  -7620,  -7504,  -4007,  -9775,
        -720,   -296,   406,    234,    -25561, -9375,  -6768,  -246,   1017,   71,     -8471,  -2781,  -1855,  -2949,
        -532,   -582,   -10262, -8940,  -557,   6358,   9354,   -6795,  -4970,  4535,   -8712,  5242,   -5605,  -849,
        76,     2953,   1477,   -1748,  6507,   2213,   9888,   -7948,  -6254,  12584,  -5957,  8457,   -539,   8075,
        4126,   1382,   916,    1029,   -10188, 9306,   -4403,  -2448,  1556,   13716,  -1962,  -6164,  -8375,  4251,
        -2954,  -11923, -6106,  3572,   4275,   7569,   4377,   -8153,  13691,  2034,   -4705,  -11546, -1111,  -61,
        1299,   -7928,  -3683,  -9658,  115,    -5025,  19443,  -7660,  -9251,  -2496,  10044,  2101,   17351,  -11424,
        11924,  5134,   665,    -8474,  -15311, 7143,   7911,   -463,   -574,   4527,   -3261,  4296,   -11403, 1863,
        8962,   3857,   4612,   -2312,  12614,  -1845,  -3346,  2030,   -2724,  -8184,  -1807,  7649,   1764,   3237,
        -1988,  -6208,  -3508,  -1986,  2428,   3151,   -2441,  -3807,  6301,   -5716,  -3773,  16074,  -5803,  1364,
        1457,   -1705,  -4284,  -782,   -2385,  1580,   3266,   12773,  -7415,  953,    7259,   10903,  8286,   757,
        -13365, 1947,   -3338,  423,    1182,   -5575,  4900,   -4443,  8152,   300,    7301,   -5671,  8683,   -2729,
        1850,   54,     2743,   4751,   13871,  8521,   12426,  -5249,  664,    -3728,  -3542,  1207,   -5751,  3703,
        4164,   8712,   375,    1048,   -2329,  -5896,  3501,   4073,   -5686,  5146,   8589,   3683,   -2735,  4452,
        1509,   4180,   -3665,  7171,   4969,   -4055,  8234,   -15513, -18623, -5335,  -15360, 245,    -6070,  19514,
        8629,   2952,   18391,  11960,  -2470,  -18211, 5877,   -2743,  -14559, 7942,   4305,   -12260, -5041,  -4695,
        -6909,  -2553,  -5606,  11322,  7098,   -552,   -1802,  10122,  -1816,  2269,   -7226,  -659,   7587,   6290,
        6807,   -3491,  4807,   -7655,  -5315,  2924,   -6584,  331,    3330,   2056,   -14799, 1027,   3121,   7040,
        166,    1269,   -2887,  -523,   -18014, 2436,   -6450,  1082,   -2009,  782,    -3363,  -6905,  12047,  -553,
        -229,   -7921,  -12336, -6137,  -1833,  -6707,  -3908,  6021,   9474,   -319,   3153,   692,    -8821,  -8953,
        -3936,  4385,   -536,   -7029,  5538,   54,     -6187,  8358,   -5307,  7262,   -4617,  -1278,  11961,  2042,
        11401,  -13478, -10348, 762,    127,    -2106,  2202,   -6390,  -13255, -18910, 1592,   -21496, -8179,  11737,
        -7576,  -2426,  6549,   -4485,  10512,  -5949,  16484,  315,    -289,   -11727, 13203,  3841,   273,    -7124,
        3707,   7108,   -2581,  10018,  -6583,  -5442,  5514,   -7598,  -12540, 1792,   16684,  -2145,  7172,   -2510,
        -7822,  -5724,  -2418,  10949,  -6392,  -2464,  -238,   11246,  -6158,  -2761,  5912,   -3372,  -5102,  -2402,
        -2866,  3882,   -2491,  -12282, -8194,  5061,   4851,   1181,   5355,   2492,   -2529,  1892,   -7485,  -8245,
        -10866, -6609,  2121,   13517,  -4855,  -18263, -5561,  10927,  -9324,  3204,   -6184,  -4268,  -6336,  -8557,
        4791,   11093,  -4355,  2761,   595,    1944,   9072,   -1051,  -2573,  -8362,  13342,  -6383,  3161,   -6979,
        -8291,  2876,   -15523, -4570,  -10742, -8376,  -823,   -5554,  6851,   -10189, -2383,  17006,  5963,   1032,
        10341,  -6075,  2775,   3689,   -5851,  4369,   -871,   -5115,  9018,   1165,   -5244,  -7129,  -9628,  2043,
        7296,   2790,   -5108,  -3898,  -2663,  2745,   -2539,  -802,   6401,   -8319,  -3563,  -6878,  1382,   -1483,
        -6152,  7041,   4107,   1950,   3110,   871,    9901,   6174,   -6993,  914,    1455,   -6032,  3340,   -3368,
        521,    -479,   -6510,  -9248,  -2185,  5273,   -10645, -954,   -11703, -1537,  -3013,  4398,   -4902,  -1810,
        8953,   8816,   -7344,  -296,   2027,   -17899, 7916,   -7095,  4830,   -480,   -9845,  887,    8060,   6724,
        -10349, 5956,   702,    6123,   11768,  -6776,  -7624,  2292,   9075,   -14019, -5224,  -3229,  991,    -331,
        20043,  -7625,  -11782, -5507,  -4023,  -3615,  19525,  -9484,  -337,   -3488,  4582,   3070,   1736,   -980,
        -9459,  -12305, 2933,   2727,   3340,   8367,   941,    1456,   -8346,  12189,  -6696,  -6666,  6453,   -6381,
        5489,   -3992,  -5494,  -4905,  4548,   -8673,  485,    1563,   -14298, 4091,   8450,   5527,   -5355,  6675,
        7276,   -3196,  5122,   3970,   -1998,  -13808, -12203, 848,    411,    -7224,  6557,   -8841,  7535,   -11865,
        686,    2197,   -3326,  -3030,  -13421, -2338,  12759,  9496,   4450,   2279,   -10986, -6667,  -17262, 11047,
        -4492,  14354,  -6420,  10859,  7625,   7611,   -12171, -12188, 5796,   -6506,  -15534, 11867,  -2053,  -3024,
        2540,   2138,   -493,   -5286,  -4119,  4365,   4130,   8014,   -5723,  -4769,  -2417,  8478,   2968,   -2258,
        19856,  -9365,  -858,   -4956,  9047,   -4676,  2881,   13592,  4929,   -5485,  -2600,  367,    13632,  -3566,
        -8073,  -3768,  5440,   -5623,  -1614,  -9096,  439,    1464,   5452,   -8785,  -9023,  6077,   -4535,  3674,
        16507,  -1457,  -6778,  -14032, 1213,   -944,   882,    5751,   1807,   10473,  -4586,  -11138, 3697,   6361,
        -516,   -6668,  -3619,  -862,   -2221,  -5013,  2167,   3348,   7166,   -7964,  9197,   290,    6240,   -1152,
        3211,   362};

    ASSERT_TRUE(ref.check_integrity());

    //
    auto taskData = std::make_shared<ppc::core::TaskData>();
    krylov_m_matmul_strip_ha_vb_seq::fill_task_data(*taskData, lhs, rhs, out);

    //
    auto task = std::make_shared<krylov_m_matmul_strip_ha_vb_seq::TaskSequential<TestElementType>>(taskData);

    //
    auto perfAttr = std::make_shared<ppc::core::PerfAttr>();
    perfAttr->num_running = 10;
    const auto t0 = std::chrono::high_resolution_clock::now();
    perfAttr->current_timer = [&] {
      auto current_time_point = std::chrono::high_resolution_clock::now();
      auto duration = std::chrono::duration_cast<std::chrono::nanoseconds>(current_time_point - t0).count();
      return static_cast<double>(duration) * 1e-9;
    };
    //
    auto perfResults = std::make_shared<ppc::core::PerfResults>();
    ppc::core::Perf perfAnalyzer(task);
    runner(perfAnalyzer, perfAttr, perfResults);
    ppc::core::Perf::print_perf_statistic(perfResults);

    EXPECT_EQ(ref, out);
  }
};

TEST_F(krylov_m_matmul_strip_ha_vb_seq_perf_test, test_pipeline_run) {
  run_perf_test([](auto &perfAnalyzer, const auto &perfAttr, const auto &perfResults) {
    perfAnalyzer.pipeline_run(perfAttr, perfResults);
  });
}

TEST_F(krylov_m_matmul_strip_ha_vb_seq_perf_test, test_task_run) {
  run_perf_test([](auto &perfAnalyzer, const auto &perfAttr, const auto &perfResults) {
    perfAnalyzer.task_run(perfAttr, perfResults);
  });
}
